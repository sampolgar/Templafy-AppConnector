<!DOCTYPE html>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
<head>
    <title>My Website</title>
</head>
<body>
    <div class="container mt-5">
        <h1>Templafy App Connector</h1>
            <form class="row g-3" id="popUpURL">
                <!-- <div class="col-md-6">
                    <label for="tenantName" class="form-label">Tenant name</label>
                    <input type="text" class="form-control" id="tenantName">
                    <small id="tenantNameHelp" class="form-text text-muted">Just the tenantname e.g. https://<mark>tenantname</mark>.templafy.com</small>
                </div> -->
                <div class="col-md-12">
                    <label for="configUrl" class="form-label">Config URL</label>
                    <input type="text" class="form-control" id="configUrl" value="https://samsandboxaus2.templafy.com/library/documents?externalSystemType=genericAppConnector&origin=https://2eb2-220-233-33-78.au.ngrok.io&settingId=638000925144325439">
                </div>
                <div class ="col-md-12">
                    <label for="jsonContent" class="form-label">JSON Content</label>
                    <textarea class="form-control" id="jsonContent" rows="25" oninput="auto_grow(this)"></textarea>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary" onclick="buttonPressed()">Open App Connector</button>
            </form>
    </div>
</body>
<script>
    let poppedUp = false;
    let requestConfigUrl = "";
    let jsonContent = {};


    const buttonPressed = () => {
        poppedUp = true;
        requestConfigUrl = document.getElementById('configUrl').value;
        jsonContent = document.getElementById('jsonContent').value;
        openPopupHandler();
    }

    const openPopupHandler = () => {
        const features = "menubar=no,location=no,resizable=no,scrollbars=no,status=no,titlebar=no,toolbar=no,width=1500,height=1000";

        openedPopUp = window.open(requestConfigUrl, "_blank", features);

        if(openedPopUp) {
            window.addEventListener("message", messageEventHandler(e));
        }
    };

    // event listener: https://developer.mozilla.org/en-US/docs/Web/API/Window/message_event
    const messageEventHandler = (event) => {
        console.log('message event handler')
        if(event.data.type === "ready" || event.data.type === "document") {
            // alert('data' + JSON.stringify(data))
            console.log('event data type: ', event.data.type)
        }

        if(event.data.type === "ready") {
            const url = URL(requestConfigUrl)
            openedPopUp.postMessage({
                type: "content",
                content: jsonContent,
            }, url.origin);
        }
        else if (event.data.type === "document") {

            const newDocumentUrl = event.data.documentUrl;
            openedPopUp.close();
            window.removeEventListener("message", messageEventHandler);
            window.location.href = newDocumentUrl;
        }
    };

    // ancillary functions
    let obj={"glossary":{"title":"example glossary","GlossDiv":{"title":"S","GlossList":{"GlossEntry":{"ID":"SGML","SortAs":"SGML","GlossTerm":"Standard Generalized Markup Language","Acronym":"SGML","Abbrev":"ISO 8879:1986","GlossDef":{"para":"A meta-markup language, used to create markup languages such as DocBook.","GlossSeeAlso":["GML","XML"]},"GlossSee":"markup"}}}}}

    document.getElementById('jsonContent').value = prettyMyJson(obj);
        
    function prettyMyJson(uglyJson) { 
        return JSON.stringify(uglyJson, undefined, 4); 
    }

    function auto_grow(element) {
        element.style.height = "5px";
        element.style.height = (element.scrollHeight)+"px";
    }

</script>
</html>